from parsers import Parser 
from nf_requester import nf_requester
from mongo import my_mongo
from postgresql import my_db_pb
import re

# Lista de nfs para consultar os dados:
nfs = [
'43240419207966000122650040002092401693814669',
'43240419207966000122650040002092411653393864',
'43240413783221003906650100002289201100429336',
'43240575400218002852650160000318941144520725',
'43240575400218002852650150000382491889137050',
'43240593015006003210651110007462361026071802',
'43240593015006001519651100013204171165575800',
'43240507473735015707650020014577681009336479',
'43240593015006001276651010000791881146923863',
'43240502765561000107650620001120029071487290',
'43240513783221003574650100004140581691017736',
'43240513783221003574650100004140371468569767',
'43240593015006003210655320000083949000039370',
'43240507473735009995650020010426501010565700',
'43240592665611010130657000000486709921989276',
'43240593015006003210651270009807931643915852',
'43240592665611044115651000003086381806645010',
'43240575400218002852650160000334411245773428',
'43240593015006003210651470004055091987531822',
'43240592754738002378654010000456611292434921',
'43240513783221003906650100002311101952387677',
'43240502765561000107650480003144961660369180',
'43240593015006000466651110003383571978850466',
'43240588010566000307650020002487231783402336',
'43240501438784002060650020003149821545104961',
'43240575400218001295650530000271571296369852',
'43240543283811015777650010013987351013987429',
'43240547960950032406650790000022871171676128',
'43240543283811015777650010013986691013986760',
'43240593015006000970651180011364551000090854',
'43240592665611032613651010003616251690977554',
'43240547960950032406650790000023001171682652',
'43240541627822000184650190000037991677344260',
'43240593015006005697651060000760721986209070',
'43240593015006003210651470004080691135569373',
'43240592665611065112651000000277001925113289',
'43240593209765008797652600000115681861612170',
'43240505918619005910650110000944161427120603',
'43240546227562000173650010000720471000722763',
'43240592754738012683654050000323771055471198',
'43240543283811015939650010008001401008001478',
'43240500776574163454653030000872601135669427',
'43240501438784006804653010000132941301394617',
'43240693015006000547651110004441521238453975',
'43240675400218001295650540000393891674105245',
'43240601438784002060653010000793321301493821',
'43240693015006000970651080012299101780821787',
'43240687093290000143651010006058771425810901'
]



rq = nf_requester()
parser = Parser()
mg = my_mongo()
db = my_db_pb()

data = []


######## NFe
def get_data_from_nfce(nfs):
    for i in nfs:
        xhtml = rq.request_nfce(i)
        dados_nfce_json = parser.parse_nfce(xhtml)
        data.append(dados_nfce_json)
    return data

######## Mongodb
def insert_data_to_mongo(data):
    mg.set_collection(collection='nfce')
    result = mg.insert_many(data= data)
    return result

def get_establishments_from_mongo():
    return mg.get_unique_estabelecimento()


def get_items_from_mongo():
    return mg.get_unique_items()


def get_sales_from_mongo():
    return mg.get_unique_compras()


######## Database

def insert_establishments_to_db(data):
   for doc in data:
        db.insert_to_estabelecimento(doc['_id'])
    
def insert_multiples_establishments_to_db(data):
    db.insert_multiples_estabelecimento(data)

def remove_duplicate_estabelecimento_to_db(): 
    db.remove_duplicate_estabelecimento()

def drop_all_tables_in_db():
    db.drop_table('raw_item')
    db.drop_table('item')
    db.drop_table('itens_por_compras')

def create_all_tables_in_db():
    db.create_raw_item_table()
    db.create_item_table()
    db.create_itens_por_compras_table()
    db.create_compras_table()

def insert_multiples_sales_to_db(data):
    db.insert_multiples_compras(data)



######## Metodos gerais

def steps_to_add_new_data():
    data = get_data_from_nfce(nfs)
    insert_data_to_mongo(data)
    establishments = get_establishments_from_mongo()
    insert_establishments_to_db(establishments)
    remove_duplicate_estabelecimento_to_db()

    sales = get_sales_from_mongo()
    insert_multiples_sales_to_db(sales)



steps_to_add_new_data()